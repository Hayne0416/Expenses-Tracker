<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Expenses Tracker (₩)</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body {
    font-family: 'Quicksand', sans-serif;
    margin: 0;
    background: #ffffff;
    color: #333;
}
.container {
    position: relative;
    background: #fefefe;
    padding: 25px 30px;
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}
h1, h2, h3 { margin-top:0; color:#2a2a2a; }
input, select, button {
    font-family: 'Quicksand', sans-serif;
}
input, select {
    padding: 10px 12px;
    margin: 5px 0;
    font-size: 16px;
    border-radius:5px;
    border:1px solid #a0a0a0;
    background:#fff;
    color:#333;
}
input:focus, select:focus {
    outline:none;
    border-color:#cc0000;
    box-shadow:0 0 5px rgba(204,0,0,0.3);
}
button {
    cursor:pointer;
    border:none;
    transition:0.3s;
    padding:10px 12px;
    border-radius:6px;
    font-size:16px;
    font-weight:500;
}
button:hover { opacity:0.9; }
#addBtn { background:#cc0000; color:#fff; }
.undo-redo { background:#555555; color:#fff; margin-right:5px; }
.undo-redo:disabled { background:#ccc; cursor:not-allowed; }
.reset-btn { position:absolute; top:25px; right:25px; background:#0077cc; color:#fff; }
.reset-btn:hover { background:#3399ff; }
.table-cell-editable { cursor:text; color:#333; }
.table-cell-editable:focus { outline:2px solid #cc0000; }
table {
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    margin-top:15px;
    border-radius:10px;
    overflow:hidden;
    background:#ffffff;
    color:#333;
}
th {
    background:#cc0000;
    color:#fff;
    position:sticky;
    top:0;
    text-align:left;
    z-index:1;
    padding:12px;
}
td {
    padding:12px;
    text-align:right;
    border-bottom:1px solid #ddd;
    background:#ffffff;
}
td:first-child { text-align:left; }
.today-row { background-color:#ffeaea; }
.sidebar {
    background:#f7f7f7;
    padding:10px 15px;
    border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,0.05);
    max-height:300px;
    overflow-y:auto;
}
.sidebar h3 { margin-top:0; color:#cc0000; font-weight:700; }
.sidebar ul { list-style:none; padding-left:0; margin:0; }
.sidebar li {
    padding:6px 8px;
    border-bottom:1px solid #ddd;
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:#fff;
    border-radius:5px;
    margin-bottom:4px;
    box-shadow:0 1px 2px rgba(0,0,0,0.05);
}
.entry-del-btn {
    background:#0077cc;
    padding:2px 6px;
    border-radius:3px;
    font-size:12px;
    color:#fff;
    border:none;
    cursor:pointer;
}
.entry-del-btn:hover { background:#3399ff; }
.flex { display:flex; gap:20px; margin:20px; }
.flex > div:first-child { flex:3; } 
.flex > div:last-child { flex:1; }  
.nav-buttons { margin-bottom:10px; }
#monthlyTotal { font-weight:bold; margin-top:10px; color:#cc0000; }
</style>
</head>
<body>
<div class="flex">
  <div class="container">
    <h1>Expenses Tracker (₩)</h1>
    <button class="reset-btn" onclick="resetData()">Reset All</button>

    <label for="amount">Enter amount (₩):</label>
    <input type="number" id="amount">
    <button id="addBtn" onclick="addAmount()">Add</button>
    <button onclick="exportCSV()">Export CSV</button>

    <h2>Daily Totals</h2>
    <label for="monthSelect">Select Month:</label>
    <select id="monthSelect" onchange="changeMonth()"></select>
    <table id="expensesTable">
    <thead>
    <tr>
      <th>Date</th>
      <th>Total (₩)</th>
    </tr>
    </thead>
    <tbody></tbody>
    </table>

    <h2>Monthly Total</h2>
    <p id="monthlyTotal">₩ 0</p>
  </div>

  <div class="sidebar">
    <h3>Today's Entries</h3>
    <div class="nav-buttons">
      <button id="undoBtn" class="undo-redo" onclick="undo()">↶ Undo</button>
      <button id="redoBtn" class="undo-redo" onclick="redo()">↷ Redo</button>
    </div>
    <ul id="todayEntries"></ul>
  </div>
</div>

<script>
let expenses = JSON.parse(localStorage.getItem("expenses")) || {};
let selectedMonth = getTodayKST().slice(0,7);
let history = [];
let historyIndex = -1;

function getTodayKST(){
  const now = new Date();
  const kst = new Date(now.getTime() + 9*60*60*1000);
  const y = kst.getUTCFullYear();
  const m = String(kst.getUTCMonth()+1).padStart(2,'0');
  const d = String(kst.getUTCDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

function playTypeSound() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.type = 'square';
  o.frequency.value = 800;
  g.gain.value = 0.05;
  o.connect(g);
  g.connect(ctx.destination);
  o.start();
  o.stop(ctx.currentTime + 0.05);
}

function addAmount(){
  const amountInput = document.getElementById("amount");
  let amount = parseFloat(amountInput.value);
  if(isNaN(amount)) return;
  playTypeSound();
  amount = -Math.abs(amount);
  const today = getTodayKST();
  if(!expenses[today]) expenses[today]=0;
  expenses[today]+=amount;
  localStorage.setItem("expenses", JSON.stringify(expenses));
  let todayLog = JSON.parse(localStorage.getItem("todayLog")) || {};
  if(todayLog.date !== today) todayLog={date:today, entries:[]};
  todayLog.entries.unshift(amount);
  saveHistory(todayLog.entries.slice());
  localStorage.setItem("todayLog", JSON.stringify(todayLog));
  renderTable(); renderTodayEntries();
  amountInput.value="";
}

function saveHistory(entries){
  history = history.slice(0, historyIndex+1);
  history.push(entries);
  historyIndex = history.length-1;
  updateUndoRedoButtons();
}

function undo(){ if(historyIndex>0){ historyIndex--; applyHistory(); } }
function redo(){ if(historyIndex<history.length-1){ historyIndex++; applyHistory(); } }
function applyHistory(){
  const today = getTodayKST();
  let todayLog = { date: today, entries: history[historyIndex].slice() };
  expenses[today] = todayLog.entries.reduce((a,b)=>a+b,0);
  localStorage.setItem("expenses", JSON.stringify(expenses));
  localStorage.setItem("todayLog", JSON.stringify(todayLog));
  renderTable(); renderTodayEntries(); updateUndoRedoButtons();
}
function updateUndoRedoButtons(){
  document.getElementById("undoBtn").disabled = historyIndex<=0;
  document.getElementById("redoBtn").disabled = historyIndex>=history.length-1;
}

function renderTodayEntries(){
  const ul=document.getElementById("todayEntries"); ul.innerHTML="";
  const todayLog = JSON.parse(localStorage.getItem("todayLog")) || {};
  if(todayLog.date!==getTodayKST()) return;
  todayLog.entries.forEach((val,i)=>{
    const li=document.createElement("li");
    li.innerHTML = `<span contenteditable class="table-cell-editable" onblur="editEntry(${i}, this.textContent)">${val}</span>
                    <button class="entry-del-btn" onclick="deleteEntry(${i})">x</button>`;
    ul.appendChild(li);
  });
}

function editEntry(index,newVal){
  const val=parseFloat(newVal);
  if(isNaN(val)) return;
  const today = getTodayKST();
  let todayLog = JSON.parse(localStorage.getItem("todayLog"));
  todayLog.entries[index]= -Math.abs(val);
  expenses[today] = todayLog.entries.reduce((a,b)=>a+b,0);
  localStorage.setItem("expenses", JSON.stringify(expenses));
  localStorage.setItem("todayLog", JSON.stringify(todayLog));
  saveHistory(todayLog.entries.slice());
  renderTable(); renderTodayEntries();
}

function deleteEntry(index){
  const today = getTodayKST();
  let todayLog = JSON.parse(localStorage.getItem("todayLog"));
  todayLog.entries.splice(index,1);
  expenses[today] = todayLog.entries.reduce((a,b)=>a+b,0);
  localStorage.setItem("expenses", JSON.stringify(expenses));
  localStorage.setItem("todayLog", JSON.stringify(todayLog));
  saveHistory(todayLog.entries.slice());
  renderTable(); renderTodayEntries();
}

function renderTable(){
  const tbody = document.querySelector("#expensesTable tbody");
  tbody.innerHTML="";
  let monthlyTotal = 0;
  for(const date in expenses){
    if(!date.startsWith(selectedMonth)) continue;
    const val = expenses[date];
    monthlyTotal+=val;
    const tr=document.createElement("tr");
    if(date===getTodayKST()) tr.className="today-row";
    const tdDate=document.createElement("td"); tdDate.textContent=date;
    const tdVal=document.createElement("td"); tdVal.textContent=`₩ ${Math.round(val).toLocaleString()}`;
    tr.appendChild(tdDate); tr.appendChild(tdVal);
    tbody.appendChild(tr);
  }
  document.getElementById("monthlyTotal").textContent=`₩ ${Math.round(monthlyTotal).toLocaleString()}`;
}

function resetData(){
  if(confirm("Are you sure you want to reset everything?")){
    expenses={}; localStorage.removeItem("expenses"); localStorage.removeItem("todayLog"); history=[]; historyIndex=-1; updateUndoRedoButtons(); renderTable(); renderTodayEntries();
  }
}

function exportCSV(){
  const rows=[["Date","Total (₩)"]];
  for(const date in expenses){
    if(date.startsWith(selectedMonth)){
      const val = expenses[date];
      rows.push([date,Math.round(val)]);
    }
  }
  const csvContent = rows.map(e=>e.join(",")).join("\n");
  const blob=new Blob([csvContent],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`expenses_${selectedMonth}.csv`; a.click();
}

function updateMonthSelect(){
  const sel = document.getElementById("monthSelect");
  sel.innerHTML="";
  const months = new Set(Object.keys(expenses).map(d=>d.slice(0,7)));
  months.add(selectedMonth);
  Array.from(months).sort().forEach(m=>{
    const opt = document.createElement("option");
    opt.value=m; opt.textContent=m;
    if(m===selectedMonth) opt.selected=true;
    sel.appendChild(opt);
  });
}
function changeMonth(){ selectedMonth=document.getElementById("monthSelect").value; renderTable(); }

document.getElementById("amount").addEventListener("keydown",function(e){ if(e.key==="Enter") addAmount(); });

updateMonthSelect(); renderTable(); renderTodayEntries();
</script>
</body>
</html>
